name: Create and publish a Docker image

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "patches/**"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.json"
      - ".eslintrc.js"
      - ".prettierrc.js"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/build.yml"
  workflow_dispatch:

# Debounce mechanism: combines concurrency control with delay to group multiple PRs
# - Only one build runs at a time for the main branch
# - If a new push occurs during the 10-minute delay, the current run is cancelled
# - This results in grouping multiple merged PRs into a single release
concurrency:
  group: build-${{ github.ref_name }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Debounce - Wait for potential new commits
        run: |
          echo "‚è±Ô∏è  Waiting 10 minutes to debounce multiple pushes to main..."
          echo "If new commits are pushed during this time, this run will be cancelled."
          sleep 10m

      - name: Checkout repository
        uses: actions/checkout@v6

      - id: normalize-repository-name
        run: echo "repository=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Generate CalVer version
        id: version
        run: |
          # Generate date-based version (CalVer: YYYY.MM.DD)
          TODAY=$(date -u +%Y.%m.%d)

          # Count existing releases with today's date prefix to determine sequence number
          # Use JSON output and jq to reliably count matching tags
          EXISTING_COUNT=$(gh release list --json tagName --jq "[.[] | select(.tagName | startswith(\"v${TODAY}.\"))] | length")

          # Handle empty result
          if [ -z "$EXISTING_COUNT" ]; then
            EXISTING_COUNT=0
          fi

          SEQUENCE=$((EXISTING_COUNT + 1))

          # Create version tag (e.g., v2025.12.02.1)
          VERSION="v${TODAY}.${SEQUENCE}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "üì¶ Generated version: ${VERSION} (commit: ${SHORT_SHA})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata and set tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.normalize-repository-name.outputs.repository }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.version }}
            type=sha,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Create Release
        run: |
          gh release create ${{ steps.version.outputs.version }} \
            --title "Release ${{ steps.version.outputs.version }}" \
            --notes "üê≥ Docker image published to GitHub Container Registry

          **Version:** \`${{ steps.version.outputs.version }}\`
          **Image:** \`${{ env.REGISTRY }}/${{ steps.normalize-repository-name.outputs.repository }}:${{ steps.version.outputs.version }}\`
          **Commit:** [${{ steps.version.outputs.short_sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

          Pull with:
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ steps.normalize-repository-name.outputs.repository }}:${{ steps.version.outputs.version }}
          # or use 'latest' for the most recent version
          docker pull ${{ env.REGISTRY }}/${{ steps.normalize-repository-name.outputs.repository }}:latest
          \`\`\`" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
